/*! videojs-chromeCast - v0.1.0 - 2014-02-20
* https://github.com/benjipott/videojs-chromeCast
* Copyright (c) 2014 Pott Benjamin; Licensed MIT */

vjs.plugin.merge=function(){var a=vjs.obj.merge.apply(this,arguments);if(a.hasOwnProperty("userAgentAllowed")&&a.enabled){a.userAgentAllowed=a.userAgentAllowed.split(",");for(var b=0,c=a.userAgentAllowed;b<c.length;b++){var d=new RegExp(c[b],"i");if(a.enabled=!!vjs.USER_AGENT.match(d),a.enabled)break}}return a},function(){var a={enabled:!0,namespace:"",title:"",description:""};vjs.plugin("chromecast",function(b){var c=vjs.plugin.merge(a,b);return c.enabled?(this.player=this,this.chromeCastComponent=new vjs.ChromeCastComponent(this,c),this.player.controlBar.addChild(this.chromeCastComponent),void 0):!1})}();var cast=cast||{};vjs.Player.prototype.chromeCastComponent={},vjs.ChromeCastComponent=vjs.Button.extend({init:function(a,b){this.settings=b,vjs.Button.call(this,a,b),a.controls()||this.disable(),this.hide(),this.el_.setAttribute("role","button"),this.initializeApi()}}),vjs.ChromeCastComponent.prototype.kind_="chromecast",vjs.ChromeCastComponent.prototype.buttonText="Chromecast",vjs.ChromeCastComponent.prototype.className="vjs-chromecast-button ",vjs.ChromeCastComponent.prototype.chromeCastBanner={},vjs.ChromeCastComponent.prototype.apiMedia=null,vjs.ChromeCastComponent.prototype.apiSession=null,vjs.ChromeCastComponent.prototype.apiInitialized=!1,vjs.ChromeCastComponent.prototype.casting=!1,vjs.ChromeCastComponent.prototype.progressFlag=1,vjs.ChromeCastComponent.prototype.timer=null,vjs.ChromeCastComponent.prototype.timerStep=1e3,vjs.ChromeCastComponent.prototype.currentMediaTime=0,vjs.ChromeCastComponent.prototype.paused=!0,vjs.ChromeCastComponent.prototype.seeking=!1,vjs.ChromeCastComponent.prototype.currentVolume=1,vjs.ChromeCastComponent.prototype.muted=!1,vjs.ChromeCastComponent.boundEvents={},vjs.ChromeCastComponent.prototype.onInitSuccess=function(){vjs.log("api_status :Initialized"),this.apiInitialized=!0},vjs.ChromeCastComponent.prototype.onInitError=function(a){vjs.log("Initialize Error: "+JSON.stringify(a))},vjs.ChromeCastComponent.prototype.sessionJoinedListener=function(a){vjs.log("Joined "+a.sessionId)},vjs.ChromeCastComponent.prototype.sessionUpdateListener=function(){},vjs.ChromeCastComponent.prototype.receiverListener=function(a){vjs.log("receivers available: "+("available"===a?"Yes":"No")),"available"===a&&this.show()},vjs.ChromeCastComponent.prototype.initializeApi=function(){if(vjs.log("ChromeCastComponent initializeApi"),vjs.IS_CHROME){if(!chrome.cast||!chrome.cast.isAvailable)return vjs.log("Cast APIs not Available. Retrying..."),setTimeout(this.initializeApi.bind(this),1e3),void 0;console.log(this.settings.appId);var a;if(this.settings.appId)var a=new chrome.cast.SessionRequest(this.settings.appId);else var a=new chrome.cast.SessionRequest(chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);var b=new chrome.cast.ApiConfig(a,this.sessionJoinedListener.bind(this),this.receiverListener.bind(this));chrome.cast.initialize(b,this.onInitSuccess.bind(this),this.onInitError.bind(this))}},vjs.ChromeCastComponent.prototype.doLaunch=function(){vjs.log("Cast video : "+this.player_.currentSrc()),this.apiInitialized?chrome.cast.requestSession(this.onSessionSuccess.bind(this),function(a){vjs.log("session_established ERROR: "+JSON.stringify(a))}):vjs.log("session_established NOT INITIALIZED")},vjs.ChromeCastComponent.prototype.onSessionSuccess=function(a){this.apiSession=a,vjs.log("session_established YES - "+a.sessionId),this.addClass("connected");var b=new chrome.cast.media.MediaInfo(this.player_.currentSrc(),"video/mp4"),c=new chrome.cast.media.LoadRequest(b);c.autoplay=!0,vjs.log("Sending Load Request: "),vjs.log(c),c.currentTime=this.player_.currentTime(),this.apiSession.loadMedia(c,this.onMediaDiscovered.bind(this),this.onMediaError.bind(this))},vjs.ChromeCastComponent.prototype.onMediaDiscovered=function(a){this.apiMedia=a,this.apiMedia.addUpdateListener(this.onMediaStatusUpdate.bind(this)),vjs.log("Got media object"),this.startProgressTimer(this.incrementMediaTime.bind(this)),vjs.log("play!!!!"),this.paused=!1,this.player_.loadTech("ChromecastTech",{}),this.player_.userActive(!0),this.casting=!0,this.apiMedia.playerState===chrome.cast.media.PlayerState.PLAYING},vjs.ChromeCastComponent.prototype.onMediaError=function(a){vjs.log("Media Error: "+JSON.stringify(a))},vjs.ChromeCastComponent.prototype.onMediaStatusUpdate=function(){this.apiMedia&&(this.progressFlag&&vjs.log(this.apiMedia.currentTime+"/"+this.apiMedia.media.duration),vjs.ChromeCastComponent.prototype.currentMediaTime=this.apiMedia.currentTime,vjs.log(this.apiMedia.playerState),"IDLE"==this.apiMedia.playerState&&(this.currentMediaTime=0,this.trigger("timeupdate"),this.onStopAppSuccess()))},vjs.ChromeCastComponent.prototype.startProgressTimer=function(a){this.timer&&(clearInterval(this.timer),this.timer=null),vjs.log("starting timer..."),this.timer=setInterval(a.bind(this),this.timerStep)},vjs.ChromeCastComponent.prototype.duration=function(){return this.apiMedia?this.apiMedia.media.duration:0},vjs.ChromeCastComponent.prototype.play=function(){this.apiMedia&&this.paused&&(this.apiMedia.play(null,this.mediaCommandSuccessCallback.bind(this,"playing started for "+this.apiMedia.sessionId),this.onError.bind(this)),this.apiMedia.addUpdateListener(this.onMediaStatusUpdate.bind(this)),this.paused=!1)},vjs.ChromeCastComponent.prototype.pause=function(){this.apiMedia&&(this.paused||(this.apiMedia.pause(null,this.mediaCommandSuccessCallback.bind(this,"paused "+this.apiMedia.sessionId),this.onError.bind(this)),this.paused=!0))},vjs.ChromeCastComponent.prototype.seekMedia=function(a){var b=new chrome.cast.media.SeekRequest;b.currentTime=a,this.apiMedia.seek(b,this.onSeekSuccess.bind(this,a),this.onError)},vjs.ChromeCastComponent.prototype.onSeekSuccess=function(a){this.currentMediaTime=a},vjs.ChromeCastComponent.prototype.setMediaVolume=function(a,b){if(this.apiMedia){var c=new chrome.cast.Volume;c.level=a,this.currentVolume=c.level,c.muted=b,this.muted=b;var d=new chrome.cast.media.VolumeRequest;d.volume=c,this.apiMedia.setVolume(d,this.mediaCommandSuccessCallback.bind(this,"media set-volume done"),this.onError),this.player_.trigger("volumechange")}},vjs.ChromeCastComponent.prototype.incrementMediaTime=function(){this.apiMedia.playerState===chrome.cast.media.PlayerState.PLAYING&&(this.currentMediaTime<this.apiMedia.media.duration?(this.currentMediaTime+=1,this.trigger("timeupdate")):(this.currentMediaTime=0,clearInterval(this.timer)))},vjs.ChromeCastComponent.prototype.updateProgressBarByTimer=function(){var a=parseInt(100*this.currentMediaTime/this.apiMedia.media.duration);this.player_.controlBar.progressControl.seekBar.bar.el_.style&&(this.player_.controlBar.progressControl.seekBar.bar.el_.style.width=vjs.round(a,2)+"%"),this.player_.controlBar.progressControl.seekBar.seekHandle.el_.style&&(this.player_.controlBar.progressControl.seekBar.seekHandle.el_.style.left=vjs.round(a,2)+"%"),this.player_.controlBar.currentTimeDisplay.content.innerHTML='<span class="vjs-control-text">Current Time </span>'+vjs.formatTime(this.currentMediaTime)},vjs.ChromeCastComponent.prototype.mediaCommandSuccessCallback=function(a){vjs.log(a)},vjs.ChromeCastComponent.prototype.onError=function(){vjs.log("error")},vjs.ChromeCastComponent.prototype.stopCasting=function(){this.apiSession.stop(this.onStopAppSuccess.bind(this),this.onError.bind(this))},vjs.ChromeCastComponent.prototype.onStopAppSuccess=function(){clearInterval(this.timer),this.casting=!1,this.removeClass("connected"),this.player_.src(this.player_.options_.sources),vjs.insertFirst(this.player_.tech.el_,this.player_.el()),"IDLE"==this.apiMedia.playerState?(this.player_.currentTime(0),this.player_.onPause()):(this.player_.currentTime(this.currentMediaTime),this.paused||this.player_.play()),this.apiMedia=null},vjs.ChromeCastComponent.prototype.buildCSSClass=function(){return this.className+vjs.Button.prototype.buildCSSClass.call(this)},vjs.ChromeCastComponent.prototype.createEl=function(){var a=vjs.Button.prototype.createEl.call(this,"div");return a},vjs.ChromeCastComponent.prototype.onClick=function(){vjs.Button.prototype.onClick.call(this),this.casting?this.stopCasting():this.doLaunch()},vjs.ChromeCastBanner=vjs.Component.extend({init:function(a,b){vjs.Component.call(this,a,b)}}),vjs.ChromeCastBanner.prototype.createEl=function(a,b){return b=vjs.obj.merge({className:this.buildCSSClass(),innerHTML:"",tabIndex:0},b),vjs.Component.prototype.createEl.call(this,a,b)},vjs.ChromeCastBanner.prototype.buildCSSClass=function(){return"vjs-currentlyCasting"},vjs.ChromecastTech=vjs.MediaTechController.extend({init:function(a,b,c){this.features.volumeControl=!0,this.features.movingMediaElementInDOM=!1,this.features.fullscreenResize=!1,this.features.progressEvents=!0,this.features.timeupdateEvents=!0,vjs.MediaTechController.call(this,a,b,c),b.source,vjs.log("ChromecastTech initialized..."),this.el_=videojs.Component.prototype.createEl("div",{id:"myId",className:"vjs-tech",innerHTML:'<img src="'+this.player_.options_.poster+'" class="backgroundImage"/><div class="currentlyCasting"><h2 class="castingLabel">Casting to device</h2></div>'}),vjs.insertFirst(this.el_,this.player_.el()),this.triggerReady()}}),vjs.ChromecastTech.apiSession={},vjs.ChromecastTech.apiMedia={},vjs.ChromecastTech.isSupported=function(){return vjs.log("isSupported"),this.player_.chromeCastComponent.apiInitialized},videojs.ChromecastTech.canPlaySource=function(a){return vjs.log("canPlaySource"),"video/mp4"==a.type},vjs.ChromecastTech.prototype.dispose=function(){vjs.MediaTechController.prototype.dispose.call(this)},vjs.ChromecastTech.prototype.play=function(){vjs.log("play"),this.player_.chromeCastComponent.play(),this.player_.onPlay()},vjs.ChromecastTech.prototype.pause=function(){vjs.log("pause"),this.player_.chromeCastComponent.pause(),this.player_.onPause()},vjs.ChromecastTech.prototype.paused=function(){return vjs.log("paused?"),this.player_.chromeCastComponent.paused},vjs.ChromecastTech.prototype.currentTime=function(){return this.player_.chromeCastComponent.currentMediaTime},vjs.ChromecastTech.prototype.setCurrentTime=function(a){vjs.log("setCurrentTime: "+a),this.player_.chromeCastComponent.seekMedia(a)},vjs.ChromecastTech.prototype.duration=function(){return vjs.log("duration"),0},vjs.ChromecastTech.prototype.buffered=function(){return vjs.log("buffered"),{length:0}},vjs.ChromecastTech.prototype.volume=function(){return this.player_.chromeCastComponent.currentVolume},vjs.ChromecastTech.prototype.setVolume=function(a){vjs.log("setVolume: "+a),this.player_.chromeCastComponent.setMediaVolume(a,!1)},vjs.ChromecastTech.prototype.muted=function(){return vjs.log("muted?"),this.player_.chromeCastComponent.muted},vjs.ChromecastTech.prototype.setMuted=function(a){vjs.log("setMuted: "+a),this.player_.chromeCastComponent.setMediaVolume(this.player_.chromeCastComponent.currentVolume,a)},vjs.ChromecastTech.prototype.supportsFullScreen=function(){return vjs.log("supportsFullScreen?"),!1},vjs.ChromecastTech.prototype.enterFullScreen=function(){vjs.log("enterFullScreen")},vjs.ChromecastTech.prototype.exitFullScreen=function(){vjs.log("exitFullScreen")},vjs.ChromecastTech.prototype.src=function(a){vjs.log("ChromecastTech src: "+a)},vjs.ChromecastTech.prototype.load=function(){vjs.log("load")},vjs.ChromecastTech.prototype.currentSrc=function(){return vjs.log("currentSrc?"),""},vjs.ChromecastTech.prototype.poster=function(){vjs.log("poster?")},vjs.ChromecastTech.prototype.setPoster=function(a){vjs.log("setPoster: "+a)},vjs.ChromecastTech.prototype.preload=function(){return vjs.log("preload?"),!0},vjs.ChromecastTech.prototype.setPreload=function(a){vjs.log("setPreload: "+a)},vjs.ChromecastTech.prototype.autoplay=function(){return vjs.log("autoplay?"),!0},vjs.ChromecastTech.prototype.setAutoplay=function(){},vjs.ChromecastTech.prototype.controls=function(){return vjs.log("controls?"),!0},vjs.ChromecastTech.prototype.setControls=function(a){vjs.log("setControls: "+a)},vjs.ChromecastTech.prototype.loop=!1,vjs.ChromecastTech.prototype.setLoop=function(){},vjs.ChromecastTech.prototype.error=function(){return!1},vjs.ChromecastTech.prototype.seeking=function(){return vjs.log("seeking?"),!1},vjs.ChromecastTech.prototype.ended=function(){return vjs.log("ended?"),!1},vjs.ChromecastTech.prototype.defaultMuted=!1;
